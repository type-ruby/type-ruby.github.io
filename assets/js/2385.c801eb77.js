"use strict";(globalThis.webpackChunkt_ruby_docs=globalThis.webpackChunkt_ruby_docs||[]).push([[2385],{2385(t,e,r){r.d(e,{DefaultRubyVM:()=>K});const n=28,s=44,i=54,a=58;class o{static read_bytes(t,e){const r=new o;return r.buf=t.getUint32(e,!0),r.buf_len=t.getUint32(e+4,!0),r}static read_bytes_array(t,e,r){const n=[];for(let s=0;s<r;s++)n.push(o.read_bytes(t,e+8*s));return n}}class l{static read_bytes(t,e){const r=new l;return r.buf=t.getUint32(e,!0),r.buf_len=t.getUint32(e+4,!0),r}static read_bytes_array(t,e,r){const n=[];for(let s=0;s<r;s++)n.push(l.read_bytes(t,e+8*s));return n}}class u{head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(t,e){t.setBigUint64(e,this.d_next,!0),t.setBigUint64(e+8,this.d_ino,!0),t.setUint32(e+16,this.dir_name.length,!0),t.setUint8(e+20,this.d_type)}write_name_bytes(t,e,r){t.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,r)),e)}constructor(t,e,r){this.d_ino=0n;const n=(new TextEncoder).encode(e);this.d_next=t,this.d_namlen=n.byteLength,this.d_type=r,this.dir_name=n}}class c{write_bytes(t,e){t.setUint8(e,this.fs_filetype),t.setUint16(e+2,this.fs_flags,!0),t.setBigUint64(e+8,this.fs_rights_base,!0),t.setBigUint64(e+16,this.fs_rights_inherited,!0)}constructor(t,e){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=t,this.fs_flags=e}}class f{write_bytes(t,e){t.setBigUint64(e,this.dev,!0),t.setBigUint64(e+8,this.ino,!0),t.setUint8(e+16,this.filetype),t.setBigUint64(e+24,this.nlink,!0),t.setBigUint64(e+32,this.size,!0),t.setBigUint64(e+38,this.atim,!0),t.setBigUint64(e+46,this.mtim,!0),t.setBigUint64(e+52,this.ctim,!0)}constructor(t,e){this.dev=0n,this.ino=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.filetype=t,this.size=e}}class d{write_bytes(t,e){t.setUint32(e,this.pr_name.byteLength,!0)}constructor(t){this.pr_name=(new TextEncoder).encode(t)}}class h{static dir(t){const e=new h;return e.tag=0,e.inner=new d(t),e}write_bytes(t,e){t.setUint32(e,this.tag,!0),this.inner.write_bytes(t,e+4)}}const b=new class{enable(t){this.log=function(t,e){if(t){return console.log.bind(console,"%c%s","color: #265BA0",e)}return()=>{}}(void 0===t||t,this.prefix)}get enabled(){return this.isEnabled}constructor(t){this.isEnabled=t,this.prefix="wasi:",this.enable(t)}}(!1);class _ extends Error{constructor(t){super("exit with exit code "+t),this.code=t}}let p=class{start(t){this.inst=t;try{return t.exports._start(),0}catch(e){if(e instanceof _)return e.code;throw e}}initialize(t){this.inst=t,t.exports._initialize&&t.exports._initialize()}constructor(t,e,r,n={}){this.args=[],this.env=[],this.fds=[],b.enable(n.debug),this.args=t,this.env=e,this.fds=r;const s=this;this.wasiImport={args_sizes_get(t,e){const r=new DataView(s.inst.exports.memory.buffer);r.setUint32(t,s.args.length,!0);let n=0;for(const i of s.args)n+=i.length+1;return r.setUint32(e,n,!0),b.log(r.getUint32(t,!0),r.getUint32(e,!0)),0},args_get(t,e){const r=new DataView(s.inst.exports.memory.buffer),n=new Uint8Array(s.inst.exports.memory.buffer),i=e;for(let a=0;a<s.args.length;a++){r.setUint32(t,e,!0),t+=4;const i=(new TextEncoder).encode(s.args[a]);n.set(i,e),r.setUint8(e+i.length,0),e+=i.length+1}return b.enabled&&b.log(new TextDecoder("utf-8").decode(n.slice(i,e))),0},environ_sizes_get(t,e){const r=new DataView(s.inst.exports.memory.buffer);r.setUint32(t,s.env.length,!0);let n=0;for(const i of s.env)n+=i.length+1;return r.setUint32(e,n,!0),b.log(r.getUint32(t,!0),r.getUint32(e,!0)),0},environ_get(t,e){const r=new DataView(s.inst.exports.memory.buffer),n=new Uint8Array(s.inst.exports.memory.buffer),i=e;for(let a=0;a<s.env.length;a++){r.setUint32(t,e,!0),t+=4;const i=(new TextEncoder).encode(s.env[a]);n.set(i,e),r.setUint8(e+i.length,0),e+=i.length+1}return b.enabled&&b.log(new TextDecoder("utf-8").decode(n.slice(i,e))),0},clock_res_get(t,e){let r;switch(t){case 1:r=5000n;break;case 0:r=1000000n;break;default:return 52}return new DataView(s.inst.exports.memory.buffer).setBigUint64(e,r,!0),0},clock_time_get(t,e,r){const n=new DataView(s.inst.exports.memory.buffer);if(0===t)n.setBigUint64(r,1000000n*BigInt((new Date).getTime()),!0);else if(1==t){let t;try{t=BigInt(Math.round(1e6*performance.now()))}catch(i){t=0n}n.setBigUint64(r,t,!0)}else n.setBigUint64(r,0n,!0);return 0},fd_advise:(t,e,r,n)=>null!=s.fds[t]?0:8,fd_allocate:(t,e,r)=>null!=s.fds[t]?s.fds[t].fd_allocate(e,r):8,fd_close(t){if(null!=s.fds[t]){const e=s.fds[t].fd_close();return s.fds[t]=void 0,e}return 8},fd_datasync:t=>null!=s.fds[t]?s.fds[t].fd_sync():8,fd_fdstat_get(t,e){if(null!=s.fds[t]){const{ret:r,fdstat:n}=s.fds[t].fd_fdstat_get();return null!=n&&n.write_bytes(new DataView(s.inst.exports.memory.buffer),e),r}return 8},fd_fdstat_set_flags:(t,e)=>null!=s.fds[t]?s.fds[t].fd_fdstat_set_flags(e):8,fd_fdstat_set_rights:(t,e,r)=>null!=s.fds[t]?s.fds[t].fd_fdstat_set_rights(e,r):8,fd_filestat_get(t,e){if(null!=s.fds[t]){const{ret:r,filestat:n}=s.fds[t].fd_filestat_get();return null!=n&&n.write_bytes(new DataView(s.inst.exports.memory.buffer),e),r}return 8},fd_filestat_set_size:(t,e)=>null!=s.fds[t]?s.fds[t].fd_filestat_set_size(e):8,fd_filestat_set_times:(t,e,r,n)=>null!=s.fds[t]?s.fds[t].fd_filestat_set_times(e,r,n):8,fd_pread(t,e,r,n,i){const a=new DataView(s.inst.exports.memory.buffer),l=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const u=o.read_bytes_array(a,e,r);let c=0;for(const e of u){const{ret:r,data:o}=s.fds[t].fd_pread(e.buf_len,n);if(0!=r)return a.setUint32(i,c,!0),r;if(l.set(o,e.buf),c+=o.length,n+=BigInt(o.length),o.length!=e.buf_len)break}return a.setUint32(i,c,!0),0}return 8},fd_prestat_get(t,e){const r=new DataView(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const{ret:n,prestat:i}=s.fds[t].fd_prestat_get();return null!=i&&i.write_bytes(r,e),n}return 8},fd_prestat_dir_name(t,e,r){if(null!=s.fds[t]){const{ret:n,prestat:i}=s.fds[t].fd_prestat_get();if(null==i)return n;const a=i.inner.pr_name;return new Uint8Array(s.inst.exports.memory.buffer).set(a.slice(0,r),e),a.byteLength>r?37:0}return 8},fd_pwrite(t,e,r,n,i){const a=new DataView(s.inst.exports.memory.buffer),o=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const u=l.read_bytes_array(a,e,r);let c=0;for(const e of u){const r=o.slice(e.buf,e.buf+e.buf_len),{ret:l,nwritten:u}=s.fds[t].fd_pwrite(r,n);if(0!=l)return a.setUint32(i,c,!0),l;if(c+=u,n+=BigInt(u),u!=r.byteLength)break}return a.setUint32(i,c,!0),0}return 8},fd_read(t,e,r,n){const i=new DataView(s.inst.exports.memory.buffer),a=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const l=o.read_bytes_array(i,e,r);let u=0;for(const e of l){const{ret:r,data:o}=s.fds[t].fd_read(e.buf_len);if(0!=r)return i.setUint32(n,u,!0),r;if(a.set(o,e.buf),u+=o.length,o.length!=e.buf_len)break}return i.setUint32(n,u,!0),0}return 8},fd_readdir(t,e,r,n,i){const a=new DataView(s.inst.exports.memory.buffer),o=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){let l=0;for(;;){const{ret:u,dirent:c}=s.fds[t].fd_readdir_single(n);if(0!=u)return a.setUint32(i,l,!0),u;if(null==c)break;if(r-l<c.head_length()){l=r;break}const f=new ArrayBuffer(c.head_length());if(c.write_head_bytes(new DataView(f),0),o.set(new Uint8Array(f).slice(0,Math.min(f.byteLength,r-l)),e),e+=c.head_length(),l+=c.head_length(),r-l<c.name_length()){l=r;break}c.write_name_bytes(o,e,r-l),e+=c.name_length(),l+=c.name_length(),n=c.d_next}return a.setUint32(i,l,!0),0}return 8},fd_renumber(t,e){if(null!=s.fds[t]&&null!=s.fds[e]){const r=s.fds[e].fd_close();return 0!=r?r:(s.fds[e]=s.fds[t],s.fds[t]=void 0,0)}return 8},fd_seek(t,e,r,n){const i=new DataView(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const{ret:a,offset:o}=s.fds[t].fd_seek(e,r);return i.setBigInt64(n,o,!0),a}return 8},fd_sync:t=>null!=s.fds[t]?s.fds[t].fd_sync():8,fd_tell(t,e){const r=new DataView(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const{ret:n,offset:i}=s.fds[t].fd_tell();return r.setBigUint64(e,i,!0),n}return 8},fd_write(t,e,r,n){const i=new DataView(s.inst.exports.memory.buffer),a=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const o=l.read_bytes_array(i,e,r);let u=0;for(const e of o){const r=a.slice(e.buf,e.buf+e.buf_len),{ret:o,nwritten:l}=s.fds[t].fd_write(r);if(0!=o)return i.setUint32(n,u,!0),o;if(u+=l,l!=r.byteLength)break}return i.setUint32(n,u,!0),0}return 8},path_create_directory(t,e,r){const n=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const i=new TextDecoder("utf-8").decode(n.slice(e,e+r));return s.fds[t].path_create_directory(i)}return 8},path_filestat_get(t,e,r,n,i){const a=new DataView(s.inst.exports.memory.buffer),o=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const l=new TextDecoder("utf-8").decode(o.slice(r,r+n)),{ret:u,filestat:c}=s.fds[t].path_filestat_get(e,l);return null!=c&&c.write_bytes(a,i),u}return 8},path_filestat_set_times(t,e,r,n,i,a,o){const l=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const u=new TextDecoder("utf-8").decode(l.slice(r,r+n));return s.fds[t].path_filestat_set_times(e,u,i,a,o)}return 8},path_link(t,e,r,n,i,a,o){const l=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]&&null!=s.fds[i]){const u=new TextDecoder("utf-8").decode(l.slice(r,r+n)),c=new TextDecoder("utf-8").decode(l.slice(a,a+o)),{ret:f,inode_obj:d}=s.fds[t].path_lookup(u,e);return null==d?f:s.fds[i].path_link(c,d,!1)}return 8},path_open(t,e,r,n,i,a,o,l,u){const c=new DataView(s.inst.exports.memory.buffer),f=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const d=new TextDecoder("utf-8").decode(f.slice(r,r+n));b.log(d);const{ret:h,fd_obj:_}=s.fds[t].path_open(e,d,i,a,o,l);if(0!=h)return h;s.fds.push(_);const p=s.fds.length-1;return c.setUint32(u,p,!0),0}return 8},path_readlink(t,e,r,n,i,a){const o=new DataView(s.inst.exports.memory.buffer),l=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const u=new TextDecoder("utf-8").decode(l.slice(e,e+r));b.log(u);const{ret:c,data:f}=s.fds[t].path_readlink(u);if(null!=f){const t=(new TextEncoder).encode(f);if(t.length>i)return o.setUint32(a,0,!0),8;l.set(t,n),o.setUint32(a,t.length,!0)}return c}return 8},path_remove_directory(t,e,r){const n=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const i=new TextDecoder("utf-8").decode(n.slice(e,e+r));return s.fds[t].path_remove_directory(i)}return 8},path_rename(t,e,r,n,i,a){const o=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]&&null!=s.fds[n]){const l=new TextDecoder("utf-8").decode(o.slice(e,e+r)),u=new TextDecoder("utf-8").decode(o.slice(i,i+a));let{ret:c,inode_obj:f}=s.fds[t].path_unlink(l);if(null==f)return c;if(c=s.fds[n].path_link(u,f,!0),0!=c&&0!=s.fds[t].path_link(l,f,!0))throw"path_link should always return success when relinking an inode back to the original place";return c}return 8},path_symlink(t,e,r,n,i){const o=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[r]){new TextDecoder("utf-8").decode(o.slice(t,t+e)),new TextDecoder("utf-8").decode(o.slice(n,n+i));return a}return 8},path_unlink_file(t,e,r){const n=new Uint8Array(s.inst.exports.memory.buffer);if(null!=s.fds[t]){const i=new TextDecoder("utf-8").decode(n.slice(e,e+r));return s.fds[t].path_unlink_file(i)}return 8},poll_oneoff(t,e,r){throw"async io not supported"},proc_exit(t){throw new _(t)},proc_raise(t){throw"raised signal "+t},sched_yield(){},random_get(t,e){const r=new Uint8Array(s.inst.exports.memory.buffer);for(let n=0;n<e;n++)r[t+n]=256*Math.random()|0},sock_recv(t,e,r){throw"sockets not supported"},sock_send(t,e,r){throw"sockets not supported"},sock_shutdown(t,e){throw"sockets not supported"},sock_accept(t,e){throw"sockets not supported"}}}};class g{fd_allocate(t,e){return a}fd_close(){return 0}fd_fdstat_get(){return{ret:a,fdstat:null}}fd_fdstat_set_flags(t){return a}fd_fdstat_set_rights(t,e){return a}fd_filestat_get(){return{ret:a,filestat:null}}fd_filestat_set_size(t){return a}fd_filestat_set_times(t,e,r){return a}fd_pread(t,e){return{ret:a,data:new Uint8Array}}fd_prestat_get(){return{ret:a,prestat:null}}fd_pwrite(t,e){return{ret:a,nwritten:0}}fd_read(t){return{ret:a,data:new Uint8Array}}fd_readdir_single(t){return{ret:a,dirent:null}}fd_seek(t,e){return{ret:a,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:a,offset:0n}}fd_write(t){return{ret:a,nwritten:0}}path_create_directory(t){return a}path_filestat_get(t,e){return{ret:a,filestat:null}}path_filestat_set_times(t,e,r,n,s){return a}path_link(t,e,r){return a}path_unlink(t){return{ret:a,inode_obj:null}}path_lookup(t,e){return{ret:a,inode_obj:null}}path_open(t,e,r,n,s,a){return{ret:i,fd_obj:null}}path_readlink(t){return{ret:a,data:null}}path_remove_directory(t){return a}path_rename(t,e,r){return a}path_unlink_file(t){return a}}class y{}class w extends g{fd_allocate(t,e){if(this.file.size>t+e);else{const r=new Uint8Array(Number(t+e));r.set(this.file.data,0),this.file.data=r}return 0}fd_fdstat_get(){return{ret:0,fdstat:new c(4,0)}}fd_filestat_set_size(t){if(this.file.size>t)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(t)));else{const e=new Uint8Array(Number(t));e.set(this.file.data,0),this.file.data=e}return 0}fd_read(t){const e=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(t)));return this.file_pos+=BigInt(e.length),{ret:0,data:e}}fd_pread(t,e){return{ret:0,data:this.file.data.slice(Number(e),Number(e+BigInt(t)))}}fd_seek(t,e){let r;switch(e){case 0:r=t;break;case 1:r=this.file_pos+t;break;case 2:r=BigInt(this.file.data.byteLength)+t;break;default:return{ret:n,offset:0n}}return r<0?{ret:n,offset:0n}:(this.file_pos=r,{ret:0,offset:this.file_pos})}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(t){if(this.file.readonly)return{ret:8,nwritten:0};if(this.file_pos+BigInt(t.byteLength)>this.file.size){const e=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(t.byteLength))),this.file.data.set(e)}return this.file.data.set(t,Number(this.file_pos)),this.file_pos+=BigInt(t.byteLength),{ret:0,nwritten:t.byteLength}}fd_pwrite(t,e){if(this.file.readonly)return{ret:8,nwritten:0};if(e+BigInt(t.byteLength)>this.file.size){const r=this.file.data;this.file.data=new Uint8Array(Number(e+BigInt(t.byteLength))),this.file.data.set(r)}return this.file.data.set(t,Number(e)),{ret:0,nwritten:t.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(t){super(),this.file_pos=0n,this.file=t}}class m extends g{fd_seek(t,e){return{ret:8,offset:0n}}fd_tell(){return{ret:8,offset:0n}}fd_allocate(t,e){return 8}fd_fdstat_get(){return{ret:0,fdstat:new c(3,0)}}fd_readdir_single(t){if(b.enabled&&(b.log("readdir_single",t),b.log(t,this.dir.contents.keys())),0n==t)return{ret:0,dirent:new u(1n,".",3)};if(1n==t)return{ret:0,dirent:new u(2n,"..",3)};if(t>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[e,r]=Array.from(this.dir.contents.entries())[Number(t-2n)];return{ret:0,dirent:new u(t+1n,e,r.stat().filetype)}}path_filestat_get(t,e){const{ret:r,path:n}=x.from(e);if(null==n)return{ret:r,filestat:null};const{ret:s,entry:i}=this.dir.get_entry_for_path(n);return null==i?{ret:s,filestat:null}:{ret:0,filestat:i.stat()}}path_lookup(t,e){const{ret:r,path:n}=x.from(t);if(null==n)return{ret:r,inode_obj:null};const{ret:s,entry:i}=this.dir.get_entry_for_path(n);return null==i?{ret:s,inode_obj:null}:{ret:0,inode_obj:i}}path_open(t,e,r,n,a,o){const{ret:l,path:u}=x.from(e);if(null==u)return{ret:l,fd_obj:null};let{ret:c,entry:f}=this.dir.get_entry_for_path(u);if(null==f){if(c!=s)return{ret:c,fd_obj:null};if(1&~r)return{ret:s,fd_obj:null};{const{ret:t,entry:n}=this.dir.create_entry_for_path(e,!(2&~r));if(null==n)return{ret:t,fd_obj:null};f=n}}else if(!(4&~r))return{ret:20,fd_obj:null};return 2&~r||3===f.stat().filetype?f.path_open(r,n,o):{ret:i,fd_obj:null}}path_create_directory(t){return this.path_open(0,t,3,0n,0n,0).ret}path_link(t,e,r){const{ret:n,path:a}=x.from(t);if(null==a)return n;if(a.is_dir)return s;const{ret:o,parent_entry:l,filename:u,entry:c}=this.dir.get_parent_dir_and_entry_for_path(a,!0);if(null==l||null==u)return o;if(null!=c){const t=3==e.stat().filetype,n=3==c.stat().filetype;if(t&&n){if(!(r&&c instanceof k))return 20;if(0!=c.contents.size)return 55}else{if(t&&!n)return i;if(!t&&n)return 31;if(4!=e.stat().filetype||4!=c.stat().filetype)return 20}}return r||3!=e.stat().filetype?(l.contents.set(u,e),0):63}path_unlink(t){const{ret:e,path:r}=x.from(t);if(null==r)return{ret:e,inode_obj:null};const{ret:n,parent_entry:i,filename:a,entry:o}=this.dir.get_parent_dir_and_entry_for_path(r,!0);return null==i||null==a?{ret:n,inode_obj:null}:null==o?{ret:s,inode_obj:null}:(i.contents.delete(a),{ret:0,inode_obj:o})}path_unlink_file(t){const{ret:e,path:r}=x.from(t);if(null==r)return e;const{ret:n,parent_entry:s,filename:i,entry:a}=this.dir.get_parent_dir_and_entry_for_path(r,!1);return null==s||null==i||null==a?n:3===a.stat().filetype?31:(s.contents.delete(i),0)}path_remove_directory(t){const{ret:e,path:r}=x.from(t);if(null==r)return e;const{ret:n,parent_entry:a,filename:o,entry:l}=this.dir.get_parent_dir_and_entry_for_path(r,!1);return null==a||null==o||null==l?n:l instanceof k&&3===l.stat().filetype?0!==l.contents.size?55:a.contents.delete(o)?0:s:i}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(t){return 8}fd_read(t){return{ret:8,data:new Uint8Array}}fd_pread(t,e){return{ret:8,data:new Uint8Array}}fd_write(t){return{ret:8,nwritten:0}}fd_pwrite(t,e){return{ret:8,nwritten:0}}constructor(t){super(),this.dir=t}}class v extends m{fd_prestat_get(){return{ret:0,prestat:h.dir(this.prestat_name)}}constructor(t,e){super(new k(e)),this.prestat_name=t}}class j extends y{path_open(t,e,r){if(this.readonly&&(e&BigInt(64))==BigInt(64))return{ret:63,fd_obj:null};if(!(8&~t)){if(this.readonly)return{ret:63,fd_obj:null};this.data=new Uint8Array([])}const n=new w(this);return 1&r&&n.fd_seek(0n,2),{ret:0,fd_obj:n}}get size(){return BigInt(this.data.byteLength)}stat(){return new f(4,this.size)}constructor(t,e){super(),this.data=new Uint8Array(t),this.readonly=!!e?.readonly}}let x=class t{static from(e){const r=new t;if(r.is_dir=e.endsWith("/"),e.startsWith("/"))return{ret:76,path:null};if(e.includes("\0"))return{ret:n,path:null};for(const t of e.split("/"))if(""!==t&&"."!==t)if(".."!==t)r.parts.push(t);else if(null==r.parts.pop())return{ret:76,path:null};return{ret:0,path:r}}to_path_string(){let t=this.parts.join("/");return this.is_dir&&(t+="/"),t}constructor(){this.parts=[],this.is_dir=!1}};class k extends y{path_open(t,e,r){return{ret:0,fd_obj:new m(this)}}stat(){return new f(3,0n)}get_entry_for_path(t){let e=this;for(const r of t.parts){if(!(e instanceof k))return{ret:i,entry:null};const t=e.contents.get(r);if(void 0===t)return b.log(r),{ret:s,entry:null};e=t}return t.is_dir&&3!=e.stat().filetype?{ret:i,entry:null}:{ret:0,entry:e}}get_parent_dir_and_entry_for_path(t,e){const r=t.parts.pop();if(void 0===r)return{ret:n,parent_entry:null,filename:null,entry:null};const{ret:a,entry:o}=this.get_entry_for_path(t);if(null==o)return{ret:a,parent_entry:null,filename:null,entry:null};if(!(o instanceof k))return{ret:i,parent_entry:null,filename:null,entry:null};const l=o.contents.get(r);return void 0===l?e?{ret:0,parent_entry:o,filename:r,entry:null}:{ret:s,parent_entry:null,filename:null,entry:null}:t.is_dir&&3!=l.stat().filetype?{ret:i,parent_entry:null,filename:null,entry:null}:{ret:0,parent_entry:o,filename:r,entry:l}}create_entry_for_path(t,e){const{ret:r,path:n}=x.from(t);if(null==n)return{ret:r,entry:null};let s,{ret:i,parent_entry:a,filename:o,entry:l}=this.get_parent_dir_and_entry_for_path(n,!0);return null==a||null==o?{ret:i,entry:null}:null!=l?{ret:20,entry:null}:(b.log("create",n),s=e?new k(new Map):new j(new ArrayBuffer(0)),a.contents.set(o,s),l=s,{ret:0,entry:l})}constructor(t){super(),this.contents=t instanceof Array?new Map(t):t}}let U=new DataView(new ArrayBuffer);function I(t){return U.buffer!==t.buffer&&(U=new DataView(t.buffer)),U}const V=new TextDecoder("utf-8"),A=new TextEncoder("utf-8");function T(t,e,r){if("string"!=typeof t)throw new TypeError("expected a string");if(0===t.length)return S=0,1;let n=0,s=0,i=0;for(;t.length>0;){s=e(s,n,1,n+t.length),n+=t.length;const{read:a,written:o}=A.encodeInto(t,new Uint8Array(r.buffer,s+i,n-i));i+=o,t=t.slice(a)}return n>i&&(s=e(s,n,1,i)),S=i,s}let S=0;class E{constructor(){this.list=[],this.head=0}insert(t){this.head>=this.list.length&&this.list.push({next:this.list.length+1,val:void 0});const e=this.head,r=this.list[e];return this.head=r.next,r.next=-1,r.val=t,e}get(t){if(t>=this.list.length)throw new RangeError("handle index not valid");const e=this.list[t];if(-1===e.next)return e.val;throw new RangeError("handle index not valid")}remove(t){const e=this.get(t),r=this.list[t];return r.val=void 0,r.next=this.head,this.head=t,e}}function R(){throw new RangeError("invalid variant discriminant for bool")}class J{constructor(){this._resource0_slab=new E}addToImports(t){"canonical_abi"in t||(t.canonical_abi={}),t.canonical_abi["resource_drop_rb-abi-value"]=t=>{this._resource0_slab.remove(t).drop()},t.canonical_abi["resource_clone_rb-abi-value"]=t=>{const e=this._resource0_slab.get(t);return this._resource0_slab.insert(e.clone())},t.canonical_abi["resource_get_rb-abi-value"]=t=>this._resource0_slab.get(t)._wasm_val,t.canonical_abi["resource_new_rb-abi-value"]=t=>{this._registry0;return this._resource0_slab.insert(new F(t,this))}}async instantiate(t,e){if(e=e||{},this.addToImports(e),t instanceof WebAssembly.Instance)this.instance=t;else if(t instanceof WebAssembly.Module)this.instance=await WebAssembly.instantiate(t,e);else if(t instanceof ArrayBuffer||t instanceof Uint8Array){const{instance:r}=await WebAssembly.instantiate(t,e);this.instance=r}else{const{instance:r}=await WebAssembly.instantiateStreaming(t,e);this.instance=r}this._exports=this.instance.exports,this._registry0=new FinalizationRegistry(this._exports["canonical_abi_drop_rb-abi-value"])}rubyShowVersion(){this._exports["ruby-show-version: func() -> ()"]()}rubyInit(t){const e=this._exports.memory,r=this._exports.cabi_realloc,n=t,s=n.length,i=r(0,0,4,8*s);for(let a=0;a<n.length;a++){const t=i+8*a,s=T(n[a],r,e),o=S;I(e).setInt32(t+4,o,!0),I(e).setInt32(t+0,s,!0)}this._exports["ruby-init: func(args: list<string>) -> ()"](i,s)}rubyInitLoadpath(){this._exports["ruby-init-loadpath: func() -> ()"]()}rbEvalStringProtect(t){const e=this._exports.memory,r=T(t,this._exports.cabi_realloc,e),n=S,s=this._exports["rb-eval-string-protect: func(str: string) -> tuple<handle<rb-abi-value>, s32>"](r,n);return[this._resource0_slab.remove(I(e).getInt32(s+0,!0)),I(e).getInt32(s+4,!0)]}rbFuncallvProtect(t,e,r){const n=this._exports.memory,s=this._exports.cabi_realloc,i=t;if(!(i instanceof F))throw new TypeError("expected instance of RbAbiValue");const a=r,o=a.length,l=s(0,0,4,4*o);for(let c=0;c<a.length;c++){const t=l+4*c,e=a[c];if(!(e instanceof F))throw new TypeError("expected instance of RbAbiValue");I(n).setInt32(t+0,this._resource0_slab.insert(e.clone()),!0)}const u=this._exports["rb-funcallv-protect: func(recv: handle<rb-abi-value>, mid: u32, args: list<handle<rb-abi-value>>) -> tuple<handle<rb-abi-value>, s32>"](this._resource0_slab.insert(i.clone()),e>>>0,l,o);return[this._resource0_slab.remove(I(n).getInt32(u+0,!0)),I(n).getInt32(u+4,!0)]}rbIntern(t){const e=this._exports.memory,r=T(t,this._exports.cabi_realloc,e),n=S;return this._exports["rb-intern: func(name: string) -> u32"](r,n)>>>0}rbErrinfo(){const t=this._exports["rb-errinfo: func() -> handle<rb-abi-value>"]();return this._resource0_slab.remove(t)}rbClearErrinfo(){this._exports["rb-clear-errinfo: func() -> ()"]()}rstringPtr(t){const e=this._exports.memory,r=t;if(!(r instanceof F))throw new TypeError("expected instance of RbAbiValue");const n=this._exports["rstring-ptr: func(value: handle<rb-abi-value>) -> string"](this._resource0_slab.insert(r.clone())),s=I(e).getInt32(n+0,!0),i=I(e).getInt32(n+4,!0),a=V.decode(new Uint8Array(e.buffer,s,i));return this._exports["cabi_post_rstring-ptr"](n),a}rbVmBugreport(){this._exports["rb-vm-bugreport: func() -> ()"]()}rbGcEnable(){const t=this._exports["rb-gc-enable: func() -> bool"]();return 0!=t&&(1==t||R())}rbGcDisable(){const t=this._exports["rb-gc-disable: func() -> bool"]();return 0!=t&&(1==t||R())}rbSetShouldProhibitRewind(t){const e=this._exports["rb-set-should-prohibit-rewind: func(new-value: bool) -> bool"](t?1:0);return 0!=e&&(1==e||R())}}class F{constructor(t,e){this._wasm_val=t,this._obj=e,this._refcnt=1,e._registry0.register(this,t,this)}clone(){return this._refcnt+=1,this}drop(){if(this._refcnt-=1,0!==this._refcnt)return;this._obj._registry0.unregister(this);const t=this._obj._exports["canonical_abi_drop_rb-abi-value"],e=this._wasm_val;delete this._obj,delete this._refcnt,delete this._wasm_val,t(e)}}class B extends J{async setInstance(t){await this.instantiate(t)}}class D{constructor(){}setUnderlying(t){this.underlying=t}rubyShowVersion(){this.underlying.rubyShowVersion()}rubyInit(t){this.underlying.rubyInit(t)}rubyInitLoadpath(){this.underlying.rubyInitLoadpath()}rbEvalStringProtect(t){return this.underlying.rbEvalStringProtect(t)}rbFuncallvProtect(t,e,r){return this.underlying.rbFuncallvProtect(t,e,r)}rbIntern(t){return this.underlying.rbIntern(t)}rbErrinfo(){return this.underlying.rbErrinfo()}rbClearErrinfo(){return this.underlying.rbClearErrinfo()}rstringPtr(t){return this.underlying.rstringPtr(t)}rbVmBugreport(){this.underlying.rbVmBugreport()}rbGcEnable(){return this.underlying.rbGcEnable()}rbGcDisable(){return this.underlying.rbGcDisable()}rbSetShouldProhibitRewind(t){return this.underlying.rbSetShouldProhibitRewind(t)}async setInstance(t){}addToImports(t){}}class P{static async instantiateModule(t){var e,r;const{module:n,wasip1:s}=t,i=new P,a={wasi_snapshot_preview1:s.wasiImport};i.addToImports(a),null===(e=t.addToImports)||void 0===e||e.call(t,a);const o=await WebAssembly.instantiate(n,a);try{await i.setInstance(o)}catch(l){throw console.error('Failed to instantiate Ruby VM. Please make sure that you have added `gem "js"` to your Gemfile.'),l}return null===(r=t.setMemory)||void 0===r||r.call(t,o.exports.memory),s.initialize(o),i.initialize(t.args),{vm:i,instance:o}}static async instantiateComponent(t){let e;e="getCoreModule"in t?async e=>{const{instantiate:r,getCoreModule:n,wasip2:s}=t,{cli:i,clocks:a,filesystem:o,io:l,random:u,sockets:c,http:f}=s,d={"ruby:js/js-runtime":e,"wasi:cli/environment":i.environment,"wasi:cli/exit":i.exit,"wasi:cli/stderr":i.stderr,"wasi:cli/stdin":i.stdin,"wasi:cli/stdout":i.stdout,"wasi:cli/terminal-input":i.terminalInput,"wasi:cli/terminal-output":i.terminalOutput,"wasi:cli/terminal-stderr":i.terminalStderr,"wasi:cli/terminal-stdin":i.terminalStdin,"wasi:cli/terminal-stdout":i.terminalStdout,"wasi:clocks/monotonic-clock":a.monotonicClock,"wasi:clocks/wall-clock":a.wallClock,"wasi:filesystem/preopens":o.preopens,"wasi:filesystem/types":o.types,"wasi:io/error":l.error,"wasi:io/poll":l.poll,"wasi:io/streams":l.streams,"wasi:random/random":u.random,"wasi:sockets/tcp":c.tcp,"wasi:http/types":f.types,"wasi:http/incoming-handler":f.incomingHandler,"wasi:http/outgoing-handler":f.outgoingHandler};return(await r(n,d,t.instantiateCore)).rubyRuntime}:t.instantiate;return{vm:await this._instantiate({},e)}}constructor(t){this.instance=null,this.interfaceState={hasJSFrameAfterRbFrame:!1};this.guest=(t=>{const e=["constructor"].concat(["setInstance","addToImports","instantiate","rbSetShouldProhibitRewind","rbGcDisable","rbGcEnable"]);for(const r of Object.getOwnPropertyNames(J.prototype)){if(e.includes(r))continue;const n=t[r];"function"==typeof n&&(t[r]=(...e)=>{if(this.interfaceState.hasJSFrameAfterRbFrame){const r=this.guest.rbSetShouldProhibitRewind(!0),s=this.guest.rbGcDisable(),i=Reflect.apply(n,t,e);return this.guest.rbSetShouldProhibitRewind(r),s||this.guest.rbGcEnable(),i}return Reflect.apply(n,t,e)})}return t})(null!=t?t:new B),this.transport=new O,this.exceptionFormatter=new N}static async _instantiate(t,e){const r=new D,n=new P(r);class s{constructor(t){this.underlying=t}}const i=n.getImports(t=>new s(t),t=>t.underlying),a=await e(Object.assign(Object.assign({},i),{throwProhibitRewindException:t=>{n.throwProhibitRewindException(t)},procToJsFunction:()=>{const t=new M(a.exportRbValueToJs(),n,n.privateObject());return new s((...e)=>t.call("call",...e.map(t=>n.wrap(t))).toJS())},rbObjectToJsRbValue:()=>{const t=new M(a.exportRbValueToJs(),n,n.privateObject());return new s(t)},JsAbiValue:s}));return r.setUnderlying(a),n.initialize(t.args),n}initialize(t=["ruby.wasm","-EUTF-8","-e_=0"]){const e=t.map(t=>t+"\0");this.guest.rubyInit(e);try{this.eval('\n        # Require Bundler standalone setup\n        if File.exist?("/bundle/bundler/setup.rb")\n          require "/bundle/bundler/setup.rb"\n        elsif File.exist?("/bundle/setup.rb")\n          # For non-CM builds, which doesn\'t use Bundler\'s standalone mode\n          require "/bundle/setup.rb"\n        end\n      ')}catch(r){console.warn("Failed to load /bundle/setup",r)}}async setInstance(t){this.instance=t,await this.guest.setInstance(t)}addToImports(t){this.guest.addToImports(t),t["rb-js-abi-host"]={rb_wasm_throw_prohibit_rewind_exception:(t,e)=>{const r=this.instance.exports.memory,n=(new TextDecoder).decode(new Uint8Array(r.buffer,t,e));this.throwProhibitRewindException(n)}},function(t,e,r){"rb-js-abi-host"in t||(t["rb-js-abi-host"]={}),t["rb-js-abi-host"]["eval-js: func(code: string) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(t,s,i){const a=r("memory"),o=t,l=s,u=V.decode(new Uint8Array(a.buffer,o,l)),c=e.evalJs(u);switch(c.tag){case"success":{const t=c.val;I(a).setInt8(i+0,0,!0),I(a).setInt32(i+4,n.insert(t),!0);break}case"failure":{const t=c.val;I(a).setInt8(i+0,1,!0),I(a).setInt32(i+4,n.insert(t),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},t["rb-js-abi-host"]["is-js: func(value: handle<js-abi-value>) -> bool"]=function(t){return e.isJs(n.get(t))?1:0},t["rb-js-abi-host"]["instance-of: func(value: handle<js-abi-value>, klass: handle<js-abi-value>) -> bool"]=function(t,r){return e.instanceOf(n.get(t),n.get(r))?1:0},t["rb-js-abi-host"]["global-this: func() -> handle<js-abi-value>"]=function(){const t=e.globalThis();return n.insert(t)},t["rb-js-abi-host"]["int-to-js-number: func(value: s32) -> handle<js-abi-value>"]=function(t){const r=e.intToJsNumber(t);return n.insert(r)},t["rb-js-abi-host"]["float-to-js-number: func(value: float64) -> handle<js-abi-value>"]=function(t){const r=e.floatToJsNumber(t);return n.insert(r)},t["rb-js-abi-host"]["string-to-js-string: func(value: string) -> handle<js-abi-value>"]=function(t,s){const i=r("memory"),a=t,o=s,l=V.decode(new Uint8Array(i.buffer,a,o)),u=e.stringToJsString(l);return n.insert(u)},t["rb-js-abi-host"]["bool-to-js-bool: func(value: bool) -> handle<js-abi-value>"]=function(t){const r=t,s=e.boolToJsBool(0!=r&&(1==r||R()));return n.insert(s)},t["rb-js-abi-host"]["proc-to-js-function: func(value: u32) -> handle<js-abi-value>"]=function(t){const r=e.procToJsFunction(t>>>0);return n.insert(r)},t["rb-js-abi-host"]["rb-object-to-js-rb-value: func(raw-rb-abi-value: u32) -> handle<js-abi-value>"]=function(t){const r=e.rbObjectToJsRbValue(t>>>0);return n.insert(r)},t["rb-js-abi-host"]["js-value-to-string: func(value: handle<js-abi-value>) -> string"]=function(t,s){const i=r("memory"),a=r("cabi_realloc"),o=T(e.jsValueToString(n.get(t)),a,i),l=S;I(i).setInt32(s+4,l,!0),I(i).setInt32(s+0,o,!0)},t["rb-js-abi-host"]["js-value-to-integer: func(value: handle<js-abi-value>) -> variant { as-float(float64), bignum(string) }"]=function(t,s){const i=r("memory"),a=r("cabi_realloc"),o=e.jsValueToInteger(n.get(t));switch(o.tag){case"as-float":{const t=o.val;I(i).setInt8(s+0,0,!0),I(i).setFloat64(s+8,+t,!0);break}case"bignum":{const t=o.val;I(i).setInt8(s+0,1,!0);const e=T(t,a,i),r=S;I(i).setInt32(s+12,r,!0),I(i).setInt32(s+8,e,!0);break}default:throw new RangeError("invalid variant specified for RawInteger")}},t["rb-js-abi-host"]["export-js-value-to-host: func(value: handle<js-abi-value>) -> ()"]=function(t){e.exportJsValueToHost(n.get(t))},t["rb-js-abi-host"]["import-js-value-from-host: func() -> handle<js-abi-value>"]=function(){const t=e.importJsValueFromHost();return n.insert(t)},t["rb-js-abi-host"]["js-value-typeof: func(value: handle<js-abi-value>) -> string"]=function(t,s){const i=r("memory"),a=r("cabi_realloc"),o=T(e.jsValueTypeof(n.get(t)),a,i),l=S;I(i).setInt32(s+4,l,!0),I(i).setInt32(s+0,o,!0)},t["rb-js-abi-host"]["js-value-equal: func(lhs: handle<js-abi-value>, rhs: handle<js-abi-value>) -> bool"]=function(t,r){return e.jsValueEqual(n.get(t),n.get(r))?1:0},t["rb-js-abi-host"]["js-value-strictly-equal: func(lhs: handle<js-abi-value>, rhs: handle<js-abi-value>) -> bool"]=function(t,r){return e.jsValueStrictlyEqual(n.get(t),n.get(r))?1:0},t["rb-js-abi-host"]["reflect-apply: func(target: handle<js-abi-value>, this-argument: handle<js-abi-value>, arguments: list<handle<js-abi-value>>) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(t,s,i,a,o){const l=r("memory"),u=a,c=i,f=[];for(let e=0;e<u;e++){const t=c+4*e;f.push(n.get(I(l).getInt32(t+0,!0)))}const d=e.reflectApply(n.get(t),n.get(s),f);switch(d.tag){case"success":{const t=d.val;I(l).setInt8(o+0,0,!0),I(l).setInt32(o+4,n.insert(t),!0);break}case"failure":{const t=d.val;I(l).setInt8(o+0,1,!0),I(l).setInt32(o+4,n.insert(t),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},t["rb-js-abi-host"]["reflect-construct: func(target: handle<js-abi-value>, arguments: list<handle<js-abi-value>>) -> handle<js-abi-value>"]=function(t,s,i){const a=r("memory"),o=i,l=s,u=[];for(let e=0;e<o;e++){const t=l+4*e;u.push(n.get(I(a).getInt32(t+0,!0)))}const c=e.reflectConstruct(n.get(t),u);return n.insert(c)},t["rb-js-abi-host"]["reflect-delete-property: func(target: handle<js-abi-value>, property-key: string) -> bool"]=function(t,s,i){const a=r("memory"),o=s,l=i,u=V.decode(new Uint8Array(a.buffer,o,l));return e.reflectDeleteProperty(n.get(t),u)?1:0},t["rb-js-abi-host"]["reflect-get: func(target: handle<js-abi-value>, property-key: string) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(t,s,i,a){const o=r("memory"),l=s,u=i,c=V.decode(new Uint8Array(o.buffer,l,u)),f=e.reflectGet(n.get(t),c);switch(f.tag){case"success":{const t=f.val;I(o).setInt8(a+0,0,!0),I(o).setInt32(a+4,n.insert(t),!0);break}case"failure":{const t=f.val;I(o).setInt8(a+0,1,!0),I(o).setInt32(a+4,n.insert(t),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},t["rb-js-abi-host"]["reflect-get-own-property-descriptor: func(target: handle<js-abi-value>, property-key: string) -> handle<js-abi-value>"]=function(t,s,i){const a=r("memory"),o=s,l=i,u=V.decode(new Uint8Array(a.buffer,o,l)),c=e.reflectGetOwnPropertyDescriptor(n.get(t),u);return n.insert(c)},t["rb-js-abi-host"]["reflect-get-prototype-of: func(target: handle<js-abi-value>) -> handle<js-abi-value>"]=function(t){const r=e.reflectGetPrototypeOf(n.get(t));return n.insert(r)},t["rb-js-abi-host"]["reflect-has: func(target: handle<js-abi-value>, property-key: string) -> bool"]=function(t,s,i){const a=r("memory"),o=s,l=i,u=V.decode(new Uint8Array(a.buffer,o,l));return e.reflectHas(n.get(t),u)?1:0},t["rb-js-abi-host"]["reflect-is-extensible: func(target: handle<js-abi-value>) -> bool"]=function(t){return e.reflectIsExtensible(n.get(t))?1:0},t["rb-js-abi-host"]["reflect-own-keys: func(target: handle<js-abi-value>) -> list<handle<js-abi-value>>"]=function(t,s){const i=r("memory"),a=r("cabi_realloc"),o=e.reflectOwnKeys(n.get(t)),l=o.length,u=a(0,0,4,4*l);for(let e=0;e<o.length;e++){const t=o[e],r=u+4*e;I(i).setInt32(r+0,n.insert(t),!0)}I(i).setInt32(s+4,l,!0),I(i).setInt32(s+0,u,!0)},t["rb-js-abi-host"]["reflect-prevent-extensions: func(target: handle<js-abi-value>) -> bool"]=function(t){return e.reflectPreventExtensions(n.get(t))?1:0},t["rb-js-abi-host"]["reflect-set: func(target: handle<js-abi-value>, property-key: string, value: handle<js-abi-value>) -> variant { success(handle<js-abi-value>), failure(handle<js-abi-value>) }"]=function(t,s,i,a,o){const l=r("memory"),u=s,c=i,f=V.decode(new Uint8Array(l.buffer,u,c)),d=e.reflectSet(n.get(t),f,n.get(a));switch(d.tag){case"success":{const t=d.val;I(l).setInt8(o+0,0,!0),I(l).setInt32(o+4,n.insert(t),!0);break}case"failure":{const t=d.val;I(l).setInt8(o+0,1,!0),I(l).setInt32(o+4,n.insert(t),!0);break}default:throw new RangeError("invalid variant specified for JsAbiResult")}},t["rb-js-abi-host"]["reflect-set-prototype-of: func(target: handle<js-abi-value>, prototype: handle<js-abi-value>) -> bool"]=function(t,r){return e.reflectSetPrototypeOf(n.get(t),n.get(r))?1:0},"canonical_abi"in t||(t.canonical_abi={});const n=new E;t.canonical_abi["resource_drop_js-abi-value"]=t=>{const r=n.remove(t);e.dropJsAbiValue&&e.dropJsAbiValue(r)}}(t,this.getImports(t=>t,t=>t),t=>this.instance.exports[t])}throwProhibitRewindException(t){let e=`Ruby APIs that may rewind the VM stack are prohibited under nested VM operation (${t})\nNested VM operation means that the call stack has sandwitched JS frames like JS -> Ruby -> JS -> Ruby caused by something like \`window.rubyVM.eval("JS.global[:rubyVM].eval('Fiber.yield')")\`\n\nPlease check your call stack and make sure that you are **not** doing any of the following inside the nested Ruby frame:\n  1. Switching fibers (e.g. Fiber#resume, Fiber.yield, and Fiber#transfer)\n     Note that \`evalAsync\` JS API switches fibers internally\n  2. Raising uncaught exceptions\n     Please catch all exceptions inside the nested operation\n  3. Calling Continuation APIs\n`;const r=new M(this.guest.rbErrinfo(),this,this.privateObject());throw"false"===r.call("nil?").toString()&&(e+="\n"+this.exceptionFormatter.format(r,this,this.privateObject())),new H(e)}getImports(t,e){function r(e){return(...r)=>{try{return{tag:"success",val:e(...r)}}catch(n){if(n instanceof H)throw n;return{tag:"failure",val:t(n)}}}}return(t=>{for(const[e,r]of Object.entries(t))"function"==typeof r&&(t[e]=(...e)=>{const n=this.interfaceState.hasJSFrameAfterRbFrame;this.interfaceState.hasJSFrameAfterRbFrame=!0;const s=Reflect.apply(r,t,e);return this.interfaceState.hasJSFrameAfterRbFrame=n,s});return t})({evalJs:r(e=>t(Function(e)())),isJs:t=>!0,globalThis:()=>{if("undefined"!=typeof globalThis)return t(globalThis);if("undefined"!=typeof globalThis)return t(globalThis);if("undefined"!=typeof window)return t(window);throw new Error("unable to locate global object")},intToJsNumber:e=>t(e),floatToJsNumber:e=>t(e),stringToJsString:e=>t(e),boolToJsBool:e=>t(e),procToJsFunction:e=>{const r=this.rbValueOfPointer(e);return t((...t)=>r.call("call",...t.map(t=>this.wrap(t))).toJS())},rbObjectToJsRbValue:e=>t(this.rbValueOfPointer(e)),jsValueToString:t=>(t=e(t),String(t)),jsValueToInteger:t=>"number"==typeof(t=e(t))?{tag:"as-float",val:t}:"bigint"==typeof t?{tag:"bignum",val:BigInt(t).toString(10)+"\0"}:"string"==typeof t?{tag:"bignum",val:t+"\0"}:void 0===t?{tag:"as-float",val:0}:{tag:"as-float",val:Number(t)},exportJsValueToHost:t=>{this.transport.takeJsValue(e(t))},importJsValueFromHost:()=>t(this.transport.consumeJsValue()),instanceOf:(t,r)=>"function"==typeof(r=e(r))&&e(t)instanceof r,jsValueTypeof:t=>typeof e(t),jsValueEqual:(t,r)=>e(t)==e(r),jsValueStrictlyEqual:(t,r)=>e(t)===e(r),reflectApply:r((r,n,s)=>{const i=s.map(t=>e(t));return t(Reflect.apply(e(r),e(n),i))}),reflectConstruct:function(t,e){throw new Error("Function not implemented.")},reflectDeleteProperty:function(t,e){throw new Error("Function not implemented.")},reflectGet:r((r,n)=>t(e(r)[n])),reflectGetOwnPropertyDescriptor:function(t,e){throw new Error("Function not implemented.")},reflectGetPrototypeOf:function(t){throw new Error("Function not implemented.")},reflectHas:function(t,e){throw new Error("Function not implemented.")},reflectIsExtensible:function(t){throw new Error("Function not implemented.")},reflectOwnKeys:function(t){throw new Error("Function not implemented.")},reflectPreventExtensions:function(t){throw new Error("Function not implemented.")},reflectSet:r((r,n,s)=>t(Reflect.set(e(r),n,e(s)))),reflectSetPrototypeOf:function(t,e){throw new Error("Function not implemented.")}})}printVersion(){this.guest.rubyShowVersion()}eval(t){return q(this,this.privateObject(),t)}evalAsync(t){const e=this.eval("require 'js'; JS");return $(this,this.privateObject(),r=>{e.call("__eval_async_rb",this.wrap(t),r)})}wrap(t){return this.transport.importJsValue(t,this)}privateObject(){return{transport:this.transport,exceptionFormatter:this.exceptionFormatter}}rbValueOfPointer(t){const e=new F(t,this.guest);return new M(e,this,this.privateObject())}}class O{constructor(){this._takenJsValue=null}takeJsValue(t){this._takenJsValue=t}consumeJsValue(){return this._takenJsValue}exportJsValue(t){return t.call("__export_to_js"),this._takenJsValue}importJsValue(t,e){return this._takenJsValue=t,e.eval('require "js"; JS::Object').call("__import_from_js")}}class M{constructor(t,e,r){this.inner=t,this.vm=e,this.privateObject=r}call(t,...e){const r=e.map(t=>t.inner);return new M(G(this.vm,this.privateObject,this.inner,t,r),this.vm,this.privateObject)}callAsync(t,...e){const r=this.vm.eval("require 'js'; JS");return $(this.vm,this.privateObject,n=>{r.call("__call_async_method",this,this.vm.wrap(t),n,...e)})}[Symbol.toPrimitive](t){return"string"===t||"default"===t?this.toString():null}toString(){const t=G(this.vm,this.privateObject,this.inner,"to_s",[]);return this.vm.guest.rstringPtr(t)}toJS(){const t=this.vm.eval("JS").call("try_convert",this);return"true"===t.call("nil?").toString()?null:this.privateObject.transport.exportJsValue(t)}}var z;!function(t){t[t.None=0]="None",t[t.Return=1]="Return",t[t.Break=2]="Break",t[t.Next=3]="Next",t[t.Retry=4]="Retry",t[t.Redo=5]="Redo",t[t.Raise=6]="Raise",t[t.Throw=7]="Throw",t[t.Fatal=8]="Fatal",t[t.Mask=15]="Mask"}(z||(z={}));class N{constructor(){this.literalsCache=null,this.isFormmatting=!1}format(t,e,r){class n extends Error{}if(this.isFormmatting)throw new n("Unexpected exception occurred during formatting exception message");this.isFormmatting=!0;try{return this._format(t,e,r)}finally{this.isFormmatting=!1}}_format(t,e,r){const[n,s,i]=(()=>{if(null==this.literalsCache){const t=[q(e,r,"0"),q(e,r,"1"),q(e,r,'"\n"')];return this.literalsCache=t,t}return this.literalsCache})();let a,o,l;try{a=t.call("class").toString()}catch(u){a="unknown"}try{l=t.call("message").toString()}catch(u){l="unknown"}try{o=t.call("backtrace")}catch(u){return this.formatString(a,l)}if("true"===o.call("nil?").toString())return this.formatString(a,l);try{const t=o.call("at",n),e=o.call("drop",s).call("join",i);return this.formatString(a,l,[t.toString(),e.toString()])}catch(u){return this.formatString(a,l)}}formatString(t,e,r){return r?`${r[0]}: ${e} (${t})\n${r[1]}`:`${t}: ${e}`}}const L=(t,e,r)=>{switch(t&z.Mask){case z.None:break;case z.Return:throw new W("unexpected return");case z.Next:throw new W("unexpected next");case z.Break:throw new W("unexpected break");case z.Redo:throw new W("unexpected redo");case z.Retry:throw new W("retry outside of rescue clause");case z.Throw:throw new W("unexpected throw");case z.Raise:case z.Fatal:const n=new M(e.guest.rbErrinfo(),e,r);if("true"===n.call("nil?").toString())throw new W("no exception object");throw e.guest.rbClearErrinfo(),new W(r.exceptionFormatter.format(n,e,r));default:throw new W(`unknown error tag: ${t}`)}};function C(t,e){try{return e()}catch(r){if(r instanceof W)throw r;try{t.guest.rbVmBugreport()}catch(r){console.error("Tried to report internal Ruby VM state but failed: ",r)}if(r instanceof WebAssembly.RuntimeError&&"unreachable"===r.message){const t=new W(`Something went wrong in Ruby VM: ${r}`);throw t.stack=r.stack,t}throw r}}const G=(t,e,r,n,s)=>{const i=t.guest.rbIntern(n+"\0");return C(t,()=>{const[n,a]=t.guest.rbFuncallvProtect(r,i,s);return L(a,t,e),n})},q=(t,e,r)=>C(t,()=>{const[n,s]=t.guest.rbEvalStringProtect(r+"\0");return L(s,t,e),new M(n,t,e)});function $(t,e,r){return new Promise((n,s)=>{const i=t.wrap({resolve:n,reject:r=>{const n=new W(e.exceptionFormatter.format(r,t,e));s(n)}});r(i)})}class W extends Error{constructor(t){super(t)}}class H extends W{constructor(t){super("Ruby Fatal Error: "+t)}}const K=async(t,e={})=>{var r,n;const s=Object.entries(null!==(r=e.env)&&void 0!==r?r:{}).map(([t,e])=>`${t}=${e}`),i=[new w(new j([])),new w(new j([])),new w(new j([])),new v("/",new Map)],a=new p([],s,i,{debug:!1}),o=null===(n=e.consolePrint)||void 0===n||n?function({stdout:t,stderr:e}={stdout:console.log,stderr:console.warn}){let r,n;function s(){if(void 0===r)throw new Error("Memory is not set");return void 0!==n&&0!==n.buffer.byteLength||(n=new DataView(r.buffer)),n}const i=new TextDecoder;return{addToImports(n){const a=n.wasi_snapshot_preview1,o=a.fd_write;a.fd_write=(n,a,l,u)=>{if(1!==n&&2!==n)return o(n,a,l,u);const c=s(),f=Array.from({length:l},(t,e)=>{const n=a+8*e,s=c.getUint32(n,!0),i=c.getUint32(n+4,!0);return new Uint8Array(r.buffer,s,i)});let d=0,h="";for(const t of f)h+=i.decode(t),d+=t.byteLength;return c.setUint32(u,d,!0),(1===n?t:e)(h),0};const l=a.fd_filestat_get;a.fd_filestat_get=(t,e)=>{if(1!==t&&2!==t)return l(t,e);const r=s(),n=l(t,e);if(0!==n)return n;const i=e+0;return r.setUint8(i,2),0};const u=a.fd_fdstat_get;a.fd_fdstat_get=(t,e)=>{if(1!==t&&2!==t)return u(t,e);const r=s(),n=e+0;r.setUint8(n,2);const i=e+8;return r.setBigUint64(i,BigInt(64),!0),0}},setMemory(t){r=t}}}():void 0,{vm:l,instance:u}=await P.instantiateModule({module:t,wasip1:a,addToImports:t=>{null==o||o.addToImports(t)},setMemory:t=>{null==o||o.setMemory(t)}});return{vm:l,wasi:a,instance:u}}}}]);