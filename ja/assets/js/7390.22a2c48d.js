"use strict";(globalThis.webpackChunkt_ruby_docs=globalThis.webpackChunkt_ruby_docs||[]).push([[7390],{7390:(e,o,r)=>{r.d(o,{loadTRubyCompiler:()=>d});let s=null,n=null,t=null,a=null;const i=new Map;let l=0;async function d(e){if(s)return e?.({state:"ready",message:"Compiler ready"}),s;if(n)return n;n=async function(e){return new Promise((o,r)=>{console.log("[T-Ruby] Creating sandboxed iframe for WASM execution..."),e?.({state:"loading",message:"Initializing compiler sandbox...",progress:5});const n=document.createElement("iframe");n.style.display="none",n.sandbox.add("allow-scripts"),n.src="/wasm-worker.html";const d=s=>{if(s.source!==n.contentWindow)return;const{type:c,data:u,requestId:m}=s.data||{};switch(console.log("[T-Ruby] Received message from worker:",c,u),c){case"loaded":console.log("[T-Ruby] Worker iframe loaded, sending init command..."),n.contentWindow?.postMessage({type:"init"},"*");break;case"progress":e?.({state:"loading",message:u.message,progress:u.progress});break;case"ready":console.log("[T-Ruby] Worker ready, health:",u.health),a=u.health,e?.({state:"ready",message:"Compiler ready",progress:100});const s={compile:async e=>new Promise((o,r)=>{const s=`req_${++l}_${Date.now()}`;i.set(s,{resolve:o,reject:r}),console.log("[T-Ruby] Sending compile request:",s),n.contentWindow?.postMessage({type:"compile",data:{code:e},requestId:s},"*"),setTimeout(()=>{i.has(s)&&(i.delete(s),r(new Error("Compile timeout")))},3e4)}),healthCheck:()=>a||{loaded:!1,version:"unknown",ruby_version:"unknown"},getVersion:()=>({t_ruby:a?.version||"unknown",ruby:a?.ruby_version||"unknown"})};t=n,o(s);break;case"compile-result":console.log("[T-Ruby] Compile result received for:",m);const c=i.get(m);c&&(i.delete(m),c.resolve(u));break;case"error":console.error("[T-Ruby] Worker error:",u.message),e?.({state:"error",message:u.message}),window.removeEventListener("message",d),document.body.removeChild(n),r(new Error(u.message))}};window.addEventListener("message",d),n.onerror=()=>{console.error("[T-Ruby] Failed to load worker iframe"),window.removeEventListener("message",d),r(new Error("Failed to load WASM worker"))};const c=setTimeout(()=>{s||(console.error("[T-Ruby] Worker initialization timeout"),window.removeEventListener("message",d),document.body.removeChild(n),r(new Error("WASM worker initialization timeout")))},6e4),u=o;o=e=>{clearTimeout(c),u(e)},document.body.appendChild(n)})}(e);try{return s=await n,s}catch(o){throw n=null,o}}}}]);