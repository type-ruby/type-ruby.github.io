<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="rss.xsl"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>T-Ruby Blog</title>
        <link>https://type-ruby.github.io/ja/blog</link>
        <description>T-Ruby Blog</description>
        <lastBuildDate>Wed, 24 Dec 2025 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>ja</language>
        <copyright>Copyright 2025 T-Ruby.</copyright>
        <item>
            <title><![CDATA[T-RubyのためのTypeScriptスタイル型推論の構築]]></title>
            <link>https://type-ruby.github.io/ja/blog/typescript-style-type-inference</link>
            <guid>https://type-ruby.github.io/ja/blog/typescript-style-type-inference</guid>
            <pubDate>Wed, 24 Dec 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[明示的な型宣言なしで自動的に型を検出する、TypeScriptに触発された静的型推論をT-Rubyに実装した話です。]]></description>
            <content:encoded><![CDATA[<p>明示的な型宣言なしで自動的に型を検出する、TypeScriptに触発された静的型推論をT-Rubyに実装した話です。</p>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="問題点">問題点<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E5%95%8F%E9%A1%8C%E7%82%B9" class="hash-link" aria-label="問題点への直接リンク" title="問題点への直接リンク" translate="no">​</a></h2>
<p>T-Rubyコードを書く際、開発者はすべての戻り値の型を明示的に宣言する必要がありました：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">greet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token symbol" style="color:rgb(248, 248, 242)">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Hello, </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(248, 248, 242)">#{</span><span class="token string-literal interpolation content">name</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<p><code>: String</code>の戻り値型がないと、生成されるRBSは<code>untyped</code>と表示されます：</p>
<div class="language-rbs codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-rbs codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token plain">def greet: (name: String) -&gt; untyped</span><br></span></code></pre></div></div>
<p>これは不便でした。戻り値の型は明らかに<code>String</code>なのに - なぜT-Rubyが自動で判断できないのでしょうか？</p>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="インスピレーションtypescriptのアプローチ">インスピレーション：TypeScriptのアプローチ<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%94%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3typescript%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AD%E3%83%BC%E3%83%81" class="hash-link" aria-label="インスピレーション：TypeScriptのアプローチへの直接リンク" title="インスピレーション：TypeScriptのアプローチへの直接リンク" translate="no">​</a></h2>
<p>TypeScriptはこれをエレガントに処理します：</p>
<div class="language-typescript codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-typescript codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">greet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string string" style="color:rgb(255, 121, 198)">Hello, </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token template-string string" style="color:rgb(255, 121, 198)">!</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>TypeScriptは戻り値の型を<code>string</code>と推論します。私たちもT-Rubyで同じ体験を望んでいました。</p>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="typescriptの動作方法">TypeScriptの動作方法<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#typescript%E3%81%AE%E5%8B%95%E4%BD%9C%E6%96%B9%E6%B3%95" class="hash-link" aria-label="TypeScriptの動作方法への直接リンク" title="TypeScriptの動作方法への直接リンク" translate="no">​</a></h3>
<p>TypeScriptの型推論は2つの主要コンポーネントで構成されています：</p>
<ol>
<li class=""><strong>Binder</strong>：パース中に制御フローグラフ（CFG）を構築</li>
<li class=""><strong>Checker</strong>：必要なときに遅延評価で型を計算、フロー分析を使用</li>
</ol>
<p>魔法は<code>getFlowTypeOfReference</code>で起こります - フローノードを逆方向にたどりながら、コードのどの地点でもシンボルの型を決定する1200行以上の関数です。</p>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="私たちの簡略化されたアプローチ">私たちの簡略化されたアプローチ<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E7%A7%81%E3%81%9F%E3%81%A1%E3%81%AE%E7%B0%A1%E7%95%A5%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E3%82%A2%E3%83%97%E3%83%AD%E3%83%BC%E3%83%81" class="hash-link" aria-label="私たちの簡略化されたアプローチへの直接リンク" title="私たちの簡略化されたアプローチへの直接リンク" translate="no">​</a></h3>
<p>Rubyの制御フローはJavaScriptより単純です。TypeScriptのフローグラフの完全な複雑さは必要ありません。代わりに以下を実装しました：</p>
<ul>
<li class=""><strong>線形データフロー分析</strong> - Rubyの直感的な実行モデル</li>
<li class=""><strong>関心の分離</strong> - IR Builder（Binderの役割）+ ASTTypeInferrer（Checkerの役割）</li>
<li class=""><strong>遅延評価</strong> - RBS生成時にのみ型を計算</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="アーキテクチャ">アーキテクチャ<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3" class="hash-link" aria-label="アーキテクチャへの直接リンク" title="アーキテクチャへの直接リンク" translate="no">​</a></h2>
<div class="language-text codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-text codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Binderステージ - IR Builder]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ソース (.trb) → Parser → IRツリー（メソッド本体を含む）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Checkerステージ - Type Inferrer]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">IRノード走査 → 型決定 → キャッシング</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[出力ステージ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">推論された型 → RBS生成</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="主要コンポーネント">主要コンポーネント<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E4%B8%BB%E8%A6%81%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88" class="hash-link" aria-label="主要コンポーネントへの直接リンク" title="主要コンポーネントへの直接リンク" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar__9bU" id="1-bodyparser---メソッド本体のパース">1. BodyParser - メソッド本体のパース<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#1-bodyparser---%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E6%9C%AC%E4%BD%93%E3%81%AE%E3%83%91%E3%83%BC%E3%82%B9" class="hash-link" aria-label="1. BodyParser - メソッド本体のパースへの直接リンク" title="1. BodyParser - メソッド本体のパースへの直接リンク" translate="no">​</a></h4>
<p>最初の課題は、パーサーがメソッド本体を分析していなかったことです - シグネチャのみを抽出していました。T-Rubyメソッド本体をIRノードに変換する<code>BodyParser</code>を構築しました：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">BodyParser</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">parse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">lines</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> start_line</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> end_line</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    statements </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 各行をIRノードにパース</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 処理：リテラル、変数、演算子、メソッド呼び出し、条件文</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token constant" style="color:rgb(189, 147, 249)">IR</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token class-name">Block</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token symbol" style="color:rgb(248, 248, 242)">statements</span><span class="token operator">:</span><span class="token plain"> statements</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<p>サポートする構文：</p>
<ul>
<li class="">リテラル：<code>"hello"</code>、<code>42</code>、<code>true</code>、<code>:symbol</code></li>
<li class="">変数：<code>name</code>、<code>@instance_var</code>、<code>@@class_var</code></li>
<li class="">演算子：<code>a + b</code>、<code>x == y</code>、<code>!flag</code></li>
<li class="">メソッド呼び出し：<code>str.upcase</code>、<code>array.map { |x| x * 2 }</code></li>
<li class="">条件文：<code>if</code>/<code>unless</code>/<code>elsif</code>/<code>else</code></li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar__9bU" id="2-typeenv---スコープチェーン管理">2. TypeEnv - スコープチェーン管理<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#2-typeenv---%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E7%AE%A1%E7%90%86" class="hash-link" aria-label="2. TypeEnv - スコープチェーン管理への直接リンク" title="2. TypeEnv - スコープチェーン管理への直接リンク" translate="no">​</a></h4>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">TypeEnv</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">initialize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">parent </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@parent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> parent</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@bindings</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">       </span><span class="token comment" style="color:rgb(98, 114, 164)"># ローカル変数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@instance_vars</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># インスタンス変数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">lookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@bindings</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@instance_vars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@parent</span><span class="token operator">&amp;.</span><span class="token plain">lookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">child_scope</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token class-name">TypeEnv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<p>これにより適切なスコーピングが可能になります - メソッドのローカル変数は他のメソッドに漏れませんが、インスタンス変数はクラス全体で共有されます。</p>
<h4 class="anchor anchorTargetStickyNavbar__9bU" id="3-asttypeinferrer---型推論エンジン">3. ASTTypeInferrer - 型推論エンジン<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#3-asttypeinferrer---%E5%9E%8B%E6%8E%A8%E8%AB%96%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3" class="hash-link" aria-label="3. ASTTypeInferrer - 型推論エンジンへの直接リンク" title="3. ASTTypeInferrer - 型推論エンジンへの直接リンク" translate="no">​</a></h4>
<p>システムの心臓部です：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">ASTTypeInferrer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token constant" style="color:rgb(189, 147, 249)">LITERAL_TYPE_MAP</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token symbol" style="color:rgb(248, 248, 242)">string</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token symbol" style="color:rgb(248, 248, 242)">integer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Integer"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token symbol" style="color:rgb(248, 248, 242)">float</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Float"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token symbol" style="color:rgb(248, 248, 242)">boolean</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"bool"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token symbol" style="color:rgb(248, 248, 242)">symbol</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Symbol"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token symbol" style="color:rgb(248, 248, 242)">nil</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"nil"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">freeze</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">infer_expression</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># まずキャッシュを確認（遅延評価）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@type_cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@type_cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    type </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">case</span><span class="token plain"> node</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">when</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">IR</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">Literal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token constant" style="color:rgb(189, 147, 249)">LITERAL_TYPE_MAP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">literal_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">when</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">IR</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">VariableRef</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lookup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">when</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">IR</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">BinaryOp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      infer_binary_op</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">when</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">IR</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">MethodCall</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      infer_method_call</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># ... その他のケース</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@type_cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">object_id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> type</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="rubyの暗黙的な戻り値の処理">Rubyの暗黙的な戻り値の処理<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#ruby%E3%81%AE%E6%9A%97%E9%BB%99%E7%9A%84%E3%81%AA%E6%88%BB%E3%82%8A%E5%80%A4%E3%81%AE%E5%87%A6%E7%90%86" class="hash-link" aria-label="Rubyの暗黙的な戻り値の処理への直接リンク" title="Rubyの暗黙的な戻り値の処理への直接リンク" translate="no">​</a></h3>
<p>Rubyの最後の式は暗黙的な戻り値です。これは型推論にとって非常に重要です：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> active</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"running"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"stopped"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 暗黙的な戻り値：String（両方の分岐から）</span><br></span></code></pre></div></div>
<p>私たちはこれを以下のように処理します：</p>
<ol>
<li class="">すべての明示的な<code>return</code>型を収集</li>
<li class="">最後の式を見つける（暗黙的な戻り値）</li>
<li class="">すべての戻り値型を統合</li>
</ol>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">infer_method_return_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">method_node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 明示的なreturnを収集</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  return_types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> terminated </span><span class="token operator">=</span><span class="token plain"> collect_return_types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">method_node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 暗黙的な戻り値を追加（メソッドが常に明示的に戻らない場合）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">unless</span><span class="token plain"> terminated</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    implicit_return </span><span class="token operator">=</span><span class="token plain"> infer_implicit_return</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">method_node</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">body</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return_types </span><span class="token operator">&lt;&lt;</span><span class="token plain"> implicit_return </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> implicit_return</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  unify_types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">return_types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="特殊ケースinitializeメソッド">特殊ケース：<code>initialize</code>メソッド<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E7%89%B9%E6%AE%8A%E3%82%B1%E3%83%BC%E3%82%B9initialize%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89" class="hash-link" aria-label="特殊ケースinitializeメソッドへの直接リンク" title="特殊ケースinitializeメソッドへの直接リンク" translate="no">​</a></h3>
<p>Rubyの<code>initialize</code>はコンストラクタです。戻り値は無視されます - <code>Class.new</code>がインスタンスを返します。RBSの慣例に従い、常に<code>void</code>と推論します：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">User</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">initialize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token symbol" style="color:rgb(248, 248, 242)">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@name</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<p>生成されるRBS：</p>
<div class="language-rbs codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-rbs codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class User</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  def initialize: (name: String) -&gt; void</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="組み込みメソッドの型知識">組み込みメソッドの型知識<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%9E%8B%E7%9F%A5%E8%AD%98" class="hash-link" aria-label="組み込みメソッドの型知識への直接リンク" title="組み込みメソッドの型知識への直接リンク" translate="no">​</a></h3>
<p>一般的なRubyメソッドの戻り値型テーブルを維持しています：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">BUILTIN_METHOD_TYPES</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[String upcase]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[String downcase]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[String length]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Integer"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[String to_i]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Integer"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[Array first]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"untyped"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># 要素型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[Array length]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Integer"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">%w[Integer to_s]</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># ... 200以上のメソッド</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">freeze</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="結果">結果<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E7%B5%90%E6%9E%9C" class="hash-link" aria-label="結果への直接リンク" title="結果への直接リンク" translate="no">​</a></h2>
<p>今ではこのT-Rubyコード：</p>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">Greeter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">initialize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token symbol" style="color:rgb(248, 248, 242)">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@name</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">greet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"Hello, </span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(248, 248, 242)">#{</span><span class="token string-literal interpolation content variable" style="color:rgb(189, 147, 249);font-style:italic">@name</span><span class="token string-literal interpolation delimiter punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">shout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">upcase</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<p>正しいRBSを自動的に生成します：</p>
<div class="language-rbs codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-rbs codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class Greeter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  @name: String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  def initialize: (name: String) -&gt; void</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  def greet: () -&gt; String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  def shout: () -&gt; String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end</span><br></span></code></pre></div></div>
<p>明示的な戻り値型は不要です！</p>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="テスト">テスト<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E3%83%86%E3%82%B9%E3%83%88" class="hash-link" aria-label="テストへの直接リンク" title="テストへの直接リンク" translate="no">​</a></h2>
<p>包括的なテストを構築しました：</p>
<ul>
<li class=""><strong>ユニットテスト</strong>：リテラル推論、演算子型、メソッド呼び出し型</li>
<li class=""><strong>E2Eテスト</strong>：RBS検証を含む完全なコンパイル</li>
</ul>
<div class="language-ruby codeBlockContainer_WMw_ theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_wTBs"><pre tabindex="0" class="prism-code language-ruby codeBlock_Nmz_ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_Uft3"><span class="token-line" style="color:#F8F8F2"><span class="token plain">it </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"文字列リテラルからStringを推論する"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  create_trb_file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"src/test.trb"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">&lt;&lt;</span><span class="token operator">~</span><span class="token constant" style="color:rgb(189, 147, 249)">TRB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:rgb(80, 250, 123)">message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"hello world"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token constant" style="color:rgb(189, 147, 249)">TRB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rbs_content </span><span class="token operator">=</span><span class="token plain"> compile_and_get_rbs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"src/test.trb"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  expect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rbs_content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">to </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">"def message: () -&gt; String"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">end</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="課題と解決策">課題と解決策<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E8%AA%B2%E9%A1%8C%E3%81%A8%E8%A7%A3%E6%B1%BA%E7%AD%96" class="hash-link" aria-label="課題と解決策への直接リンク" title="課題と解決策への直接リンク" translate="no">​</a></h2>
<table><thead><tr><th>課題</th><th>解決策</th></tr></thead><tbody><tr><td>メソッド本体のパースがない</td><td>T-Ruby構文用のカスタムBodyParserを構築</td></tr><tr><td>暗黙的な戻り値</td><td>ブロックの最後の式を分析</td></tr><tr><td>再帰メソッド</td><td>2パス分析（シグネチャを先に、次に本体）</td></tr><tr><td>複雑な式</td><td>段階的に拡張：リテラル → 変数 → 演算子 → メソッド呼び出し</td></tr><tr><td>ユニオン型</td><td>すべての戻りパスを収集して統合</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="今後の計画">今後の計画<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E4%BB%8A%E5%BE%8C%E3%81%AE%E8%A8%88%E7%94%BB" class="hash-link" aria-label="今後の計画への直接リンク" title="今後の計画への直接リンク" translate="no">​</a></h2>
<ul>
<li class=""><strong>ジェネリック推論</strong>：<code>[1, 2, 3]</code> → <code>Array[Integer]</code></li>
<li class=""><strong>ブロック/ラムダ型</strong>：ブロックパラメータと戻り値型を推論</li>
<li class=""><strong>型の絞り込み</strong>：<code>if x.is_a?(String)</code>の後でよりスマートな型</li>
<li class=""><strong>クロスメソッド推論</strong>：他のメソッドから推論された型を使用</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="結論">結論<a href="https://type-ruby.github.io/ja/blog/typescript-style-type-inference#%E7%B5%90%E8%AB%96" class="hash-link" aria-label="結論への直接リンク" title="結論への直接リンク" translate="no">​</a></h2>
<p>TypeScriptのアプローチを研究し、Rubyのよりシンプルなセマンティクスに適応させることで、実用的な型推論システムを構築しました。主要な洞察：</p>
<ol>
<li class=""><strong>メソッド本体をパース</strong> - コードを見なければ型は推論できない</li>
<li class=""><strong>キャッシングによる遅延評価</strong> - 必要になるまで計算しない</li>
<li class=""><strong>Rubyイディオムを処理</strong> - 暗黙的な戻り値、<code>initialize</code>など</li>
<li class=""><strong>シンプルに始める</strong> - まずリテラル、次に複雑さを増す</li>
</ol>
<p>型推論によりT-Rubyはより自然になります。Rubyコードを書いて、型安全性を得ましょう - アノテーション不要で。</p>
<hr>
<p><em>型推論システムはT-Rubyで利用可能です。試してみて、ご意見をお聞かせください！</em></p>]]></content:encoded>
            <category>technical</category>
            <category>type-inference</category>
            <category>compiler</category>
        </item>
        <item>
            <title><![CDATA[T-Ruby ブログへようこそ]]></title>
            <link>https://type-ruby.github.io/ja/blog/welcome</link>
            <guid>https://type-ruby.github.io/ja/blog/welcome</guid>
            <pubDate>Wed, 24 Dec 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[公式 T-Ruby ブログへようこそ！ここでは、チュートリアル、技術的な詳細解説、型安全な Ruby 開発に関するインサイトを共有していきます。]]></description>
            <content:encoded><![CDATA[<p>公式 T-Ruby ブログへようこそ！ここでは、チュートリアル、技術的な詳細解説、型安全な Ruby 開発に関するインサイトを共有していきます。</p>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="このブログで見つけられるもの">このブログで見つけられるもの<a href="https://type-ruby.github.io/ja/blog/welcome#%E3%81%93%E3%81%AE%E3%83%96%E3%83%AD%E3%82%B0%E3%81%A7%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%82%E3%81%AE" class="hash-link" aria-label="このブログで見つけられるものへの直接リンク" title="このブログで見つけられるものへの直接リンク" translate="no">​</a></h2>
<p>このブログでは以下のコンテンツを提供します：</p>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="チュートリアル">チュートリアル<a href="https://type-ruby.github.io/ja/blog/welcome#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB" class="hash-link" aria-label="チュートリアルへの直接リンク" title="チュートリアルへの直接リンク" translate="no">​</a></h3>
<p>T-Ruby を最大限に活用するためのステップバイステップガイド。基本的な型アノテーションから高度なジェネリックパターンまで、すべてをカバーします。</p>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="技術的な詳細解説">技術的な詳細解説<a href="https://type-ruby.github.io/ja/blog/welcome#%E6%8A%80%E8%A1%93%E7%9A%84%E3%81%AA%E8%A9%B3%E7%B4%B0%E8%A7%A3%E8%AA%AC" class="hash-link" aria-label="技術的な詳細解説への直接リンク" title="技術的な詳細解説への直接リンク" translate="no">​</a></h3>
<p>T-Ruby の型システムの内部を探ります。型推論の仕組み、RBS ファイルの生成方法、プロジェクトの設計決定について学びます。</p>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="ベストプラクティス">ベストプラクティス<a href="https://type-ruby.github.io/ja/blog/welcome#%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9" class="hash-link" aria-label="ベストプラクティスへの直接リンク" title="ベストプラクティスへの直接リンク" translate="no">​</a></h3>
<p>型安全な Ruby コードを書くための実践的なパターンとプラクティス。実際のプロジェクトからの例を共有し、避けるべき一般的な落とし穴について議論します。</p>
<h3 class="anchor anchorTargetStickyNavbar__9bU" id="コミュニティハイライト">コミュニティハイライト<a href="https://type-ruby.github.io/ja/blog/welcome#%E3%82%B3%E3%83%9F%E3%83%A5%E3%83%8B%E3%83%86%E3%82%A3%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88" class="hash-link" aria-label="コミュニティハイライトへの直接リンク" title="コミュニティハイライトへの直接リンク" translate="no">​</a></h3>
<p>T-Ruby コミュニティからの興味深いプロジェクトや貢献を紹介します。</p>
<h2 class="anchor anchorTargetStickyNavbar__9bU" id="最新情報を入手">最新情報を入手<a href="https://type-ruby.github.io/ja/blog/welcome#%E6%9C%80%E6%96%B0%E6%83%85%E5%A0%B1%E3%82%92%E5%85%A5%E6%89%8B" class="hash-link" aria-label="最新情報を入手への直接リンク" title="最新情報を入手への直接リンク" translate="no">​</a></h2>
<p>リリース発表やプロジェクトの更新については、<a class="" href="https://type-ruby.github.io/ja/news">ニュース</a>セクションをご覧ください。詳細なコンテンツについては、このブログをブックマークして定期的にチェックしてください。</p>
<p>この旅を皆さんと共有できることを楽しみにしています。Happy typing！</p>]]></content:encoded>
            <category>announcement</category>
        </item>
    </channel>
</rss>