"use strict";(globalThis.webpackChunkt_ruby_docs=globalThis.webpackChunkt_ruby_docs||[]).push([[7390],{7390:(e,n,r)=>{r.d(n,{loadTRubyCompiler:()=>d});let o=null,s=null,t=null,a=null;const l=new Map;let i=0;const c="<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://cdn.jsdelivr.net;\">\n  <title>T-Ruby WASM Worker</title>\n</head>\n<body>\n<script type=\"module\">\n// CDN URLs\nconst RUBY_WASM_CDN = 'https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.7.0/dist/browser/+esm';\nconst RUBY_WASM_BINARY = 'https://cdn.jsdelivr.net/npm/@ruby/3.3-wasm-wasi@2.7.0/dist/ruby+stdlib.wasm';\n\n// Bootstrap code for T-Ruby compiler\nconst BOOTSTRAP_CODE = `\nrequire \"json\"\n\n$trb_compiler = nil\n\ndef get_compiler\n  $trb_compiler ||= TRuby::Compiler.new\nend\n\ndef __trb_compile__(code)\n  compiler = get_compiler\n\n  begin\n    result = compiler.compile_string(code)\n\n    {\n      success: result[:errors].empty?,\n      ruby: result[:ruby] || \"\",\n      rbs: result[:rbs] || \"\",\n      errors: result[:errors] || []\n    }.to_json\n  rescue TRuby::ParseError => e\n    {\n      success: false,\n      ruby: \"\",\n      rbs: \"\",\n      errors: [e.message]\n    }.to_json\n  rescue StandardError => e\n    {\n      success: false,\n      ruby: \"\",\n      rbs: \"\",\n      errors: [\"Compilation error: \" + e.message]\n    }.to_json\n  end\nend\n\ndef __trb_health_check__\n  {\n    loaded: defined?(TRuby) == \"constant\",\n    version: defined?(TRuby::VERSION) ? TRuby::VERSION : \"unknown\",\n    ruby_version: RUBY_VERSION\n  }.to_json\nend\n`;\n\nlet vm = null;\nlet isReady = false;\n\n// Send message to parent\nfunction sendToParent(type, data, requestId) {\n  parent.postMessage({ type, data, requestId }, '*');\n}\n\n// Initialize Ruby VM\nasync function initialize() {\n  try {\n    console.log('[WASM Worker] Step 1: Loading Ruby WASM module...');\n    sendToParent('progress', { message: 'Loading Ruby runtime...', progress: 10 });\n\n    const { DefaultRubyVM } = await import(RUBY_WASM_CDN);\n    console.log('[WASM Worker] Step 1 complete');\n\n    console.log('[WASM Worker] Step 2: Fetching WASM binary...');\n    sendToParent('progress', { message: 'Downloading Ruby WASM binary...', progress: 30 });\n\n    const response = await fetch(RUBY_WASM_BINARY);\n    const wasmModule = await WebAssembly.compileStreaming(response);\n    console.log('[WASM Worker] Step 2 complete');\n\n    console.log('[WASM Worker] Step 3: Initializing Ruby VM...');\n    sendToParent('progress', { message: 'Initializing Ruby VM...', progress: 60 });\n\n    const result = await DefaultRubyVM(wasmModule);\n    vm = result.vm;\n    console.log('[WASM Worker] Step 3 complete');\n\n    console.log('[WASM Worker] Step 4: Loading T-Ruby bootstrap...');\n    sendToParent('progress', { message: 'Loading T-Ruby compiler...', progress: 80 });\n\n    vm.eval(BOOTSTRAP_CODE);\n    console.log('[WASM Worker] Step 4 complete');\n\n    // Health check\n    const healthResult = vm.eval('__trb_health_check__');\n    console.log('[WASM Worker] Health check:', healthResult.toString());\n\n    isReady = true;\n    sendToParent('ready', { health: JSON.parse(healthResult.toString()) });\n\n  } catch (error) {\n    console.error('[WASM Worker] Init error:', error);\n    sendToParent('error', { message: error.message });\n  }\n}\n\n// Compile code\nfunction compile(code, requestId) {\n  if (!isReady || !vm) {\n    sendToParent('compile-result', {\n      success: false,\n      errors: ['Compiler not ready']\n    }, requestId);\n    return;\n  }\n\n  try {\n    console.log('[WASM Worker] Compiling:', code.substring(0, 50) + '...');\n    const resultJson = vm.eval('__trb_compile__(' + JSON.stringify(code) + ')');\n    const result = JSON.parse(resultJson.toString());\n    console.log('[WASM Worker] Compile result:', result);\n    sendToParent('compile-result', result, requestId);\n  } catch (error) {\n    console.error('[WASM Worker] Compile error:', error);\n    sendToParent('compile-result', {\n      success: false,\n      ruby: '',\n      rbs: '',\n      errors: [error.message]\n    }, requestId);\n  }\n}\n\n// Listen for messages from parent\nwindow.addEventListener('message', (event) => {\n  const { type, data, requestId } = event.data || {};\n\n  switch (type) {\n    case 'init':\n      initialize();\n      break;\n    case 'compile':\n      compile(data.code, requestId);\n      break;\n  }\n});\n\n// Signal that worker is loaded\nsendToParent('loaded', {});\n<\/script>\n</body>\n</html>";async function d(e){if(o)return e?.({state:"ready",message:"Compiler ready"}),o;if(s)return s;s=async function(e){return new Promise((n,r)=>{console.log("[T-Ruby] Creating sandboxed srcdoc iframe for WASM execution..."),e?.({state:"loading",message:"Initializing compiler sandbox...",progress:5});const s=document.createElement("iframe");s.style.display="none";const d=new Blob([c],{type:"text/html"}),u=URL.createObjectURL(d);s.src=u,s.onload=()=>{URL.revokeObjectURL(u)};const m=o=>{if(o.source!==s.contentWindow)return;const{type:c,data:d,requestId:u}=o.data||{};switch(console.log("[T-Ruby] Received message from worker:",c,d),c){case"loaded":console.log("[T-Ruby] Worker iframe loaded, sending init command..."),s.contentWindow?.postMessage({type:"init"},"*");break;case"progress":e?.({state:"loading",message:d.message,progress:d.progress});break;case"ready":console.log("[T-Ruby] Worker ready, health:",d.health),a=d.health,e?.({state:"ready",message:"Compiler ready",progress:100});const o={compile:async e=>new Promise((n,r)=>{const o=`req_${++i}_${Date.now()}`;l.set(o,{resolve:n,reject:r}),console.log("[T-Ruby] Sending compile request:",o),s.contentWindow?.postMessage({type:"compile",data:{code:e},requestId:o},"*"),setTimeout(()=>{l.has(o)&&(l.delete(o),r(new Error("Compile timeout")))},3e4)}),healthCheck:()=>a||{loaded:!1,version:"unknown",ruby_version:"unknown"},getVersion:()=>({t_ruby:a?.version||"unknown",ruby:a?.ruby_version||"unknown"})};t=s,n(o);break;case"compile-result":console.log("[T-Ruby] Compile result received for:",u);const c=l.get(u);c&&(l.delete(u),c.resolve(d));break;case"error":console.error("[T-Ruby] Worker error:",d.message),e?.({state:"error",message:d.message}),window.removeEventListener("message",m),document.body.removeChild(s),r(new Error(d.message))}};window.addEventListener("message",m),s.onerror=()=>{console.error("[T-Ruby] Failed to load worker iframe"),window.removeEventListener("message",m),r(new Error("Failed to load WASM worker"))};const p=setTimeout(()=>{o||(console.error("[T-Ruby] Worker initialization timeout"),window.removeEventListener("message",m),document.body.removeChild(s),r(new Error("WASM worker initialization timeout")))},6e4),g=n;n=e=>{clearTimeout(p),g(e)},document.body.appendChild(s)})}(e);try{return o=await s,o}catch(n){throw s=null,n}}}}]);